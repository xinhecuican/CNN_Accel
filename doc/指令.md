# conf_buf

配置缓存的地址，长宽，步长，卷积核等信息

| command | rj   | rk   | imm  |
| ------- | ---- | ---- | ---- |
| 0x0     | 地址 | 参数 | 0x0  |

参数的定义如下：

```c
struct {
    uint32_t buf_refresh: 1;
    uint32_t wadd: 1;
    uint32_t padding_valid: 4;
    uint32_t weight_size: 2;
    uint32_t buf_size: 2;
    uint32_t kernel_width: 3;
    uint32_t kernel_height: 3;
    uint32_t buf_width: 5;
    uint32_t buf_height: 4;
    uint32_t stride: 2;
    uint32_t kernel_num: 3;
    uint32_t padding: 2;
};
```

| 字段          | 说明                                                         |
| ------------- | ------------------------------------------------------------ |
| buf_refresh   | 下次卷积操作时是否更新缓存                                   |
| wadd          | 是否将结果和对应地址的数据相加再写回                         |
| padding_valid | 四边的填充是否有效，其中任何一位都可以为1或0<br/>例如1010是有效值<br>0001: 第一列<br>0010: 最后一列<br>0100: 第一行<br>1000: 最后一行 |
| weight_size| 权重的数据类型<br>00: int8<br>01: int16<br>10: int32 |
| buf_size | 缓存的数据类型 |
| kernel_width | 卷积核的宽度 |
| kernel_height | 卷积核的高度 |
| buf_width | 缓存的宽度，单位为int8 |
| buf_height | 缓存的高度 |
| stride | 步幅 |
| kernel_num | 卷积核数量 |
| padding | 填充的大小 |

约束：

- 卷积操作只支持2x2和3x3的卷积核
- 只支持卷积核为2的均值池化

# conf_res

配置每个卷积核的写回地址及偏置

| COMMAND | RJ         | RK              | IMM    |
| ------- | ---------- | --------------- | ------ |
| 0x1     | 地址或偏置 | 选择第k个卷积核 | 见下文 |

通过IMM字段选择配置地址或配置：

- 0x1: 配置地址
- 0x2: 配置偏置
- 0x4: 将偏置清零
- 0x5: 配置地址并将偏置清零

> 权重计算和wadd不能同时进行

# conv

执行卷积或池化操作

| COMMAND | RJ                                     | IMM          |
| ------- | -------------------------------------- | ------------ |
| 0x2     | 权重的地址，池化操作时用于选择池化类型 | 选择具体操作 |

IMM各位作用为：

- 0x1: 执行卷积操作
- 0x2: 执行池化操作
- 0x4: 执行Relu激活函数
- 0x5: 执行卷积操作并激活



池化类型为：

- 0x0: 最小池化
- 0x1: 最大池化
- 0x2: 均值池化

# conf_offset

配置缓存及结果每一行的偏移

| COMMAND | RJ                        | RK                                                   | IMM  |
| ------- | ------------------------- | ---------------------------------------------------- | ---- |
| 0x3     | [15: 0]有效，为缓存的偏移 | [31: 16]为输出每一行大小<br>[15:0]为输出每一行的偏移 | 0x0  |

该条指令是为了处理图像大小大于硬件缓存大小而设计的。

例如28x28的图像，而缓存的大小为8x8,由于数据在内存中是连续存储，因此当缓存读取第一行之后需要跳过20个数据来访问第二行的第一个数据。
